name: Deploy PR to Develop

on:
  issue_comment:
    types: [created]

concurrency:
  group: deploy-develop
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare develop_auto branch
    if: >
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, 'develop deploy')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_branch: ${{ steps.get_pr.outputs.branch }}

    steps:
      - name: Verify commenter has write access
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor,
              });
              const hasWrite = ['admin', 'write', 'maintain'].includes(data.permission);
              if (!hasWrite) {
                core.setFailed(`@${context.actor} does not have write access and cannot trigger deployments (permission: ${data.permission}). Required: write, admin, or maintain.`);
              }
            } catch (e) {
              core.setFailed(`Could not verify permissions for @${context.actor}: ${e.message}`);
            }

      - name: Get PR info and block fork PRs
        id: get_pr
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            if (pr.data.head.repo.fork) {
              const body = [
                '‚ùå **Deploy to develop failed**',
                '',
                'Pull requests from forked repositories are not supported for security reasons.',
                'Please open a pull request from a branch on the main repository.',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
              
              core.setFailed('Fork PRs are not supported.');
              return;
            }

            core.setOutput('branch', pr.data.head.ref);

      - name: Post workflow started comment
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'üöÄ **Deploy to develop triggered**',
                '',
                'Preparing `develop_auto` branch and queuing deployment to `connect-develop`...',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare develop_auto and merge branches
        id: merge
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BRANCH="${{ steps.get_pr.outputs.branch }}"
          git fetch --all

          # --- Step 1: Set up develop_auto ---
          if git ls-remote --exit-code --heads origin develop_auto > /dev/null 2>&1; then
            echo "develop_auto exists ‚Äî checking out and merging main into it"
            git checkout -B develop_auto origin/develop_auto

            if ! git merge origin/main --no-edit -m "chore: sync main into develop_auto [auto]"; then
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
              git merge --abort
              
              # Create conflict resolution branch
              CONFLICT_BRANCH="conflict/sync-main-${GITHUB_RUN_ID}"
              git checkout -b "$CONFLICT_BRANCH" origin/main
              git push origin "$CONFLICT_BRANCH"
              
              # Create PR
              if ! PR_URL=$(gh pr create --base develop_auto --head "$CONFLICT_BRANCH" --title "Resolve conflicts: Sync main into develop_auto" --body "Merge conflict detected while syncing main into develop_auto for deployment. Please resolve conflicts here."); then
                echo "‚ö†Ô∏è Failed to create PR automatically (likely due to missing 'Allow GitHub Actions to create and approve pull requests' permission)."
                PR_URL="${{ github.server_url }}/${{ github.repository }}/compare/develop_auto...${CONFLICT_BRANCH}?expand=1"
              fi
              
              {
                echo "success=false"
                echo "conflict_stage=main_to_develop_auto"
                echo "conflict_files<<CONFLICT_EOF"
                echo "$CONFLICT_FILES"
                echo "CONFLICT_EOF"
                echo "conflict_pr_url=$PR_URL"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi
          else
            echo "develop_auto does not exist ‚Äî creating from main"
            git checkout -b develop_auto origin/main
          fi

          # --- Step 2: Merge PR branch into develop_auto ---
          if ! git merge "origin/${PR_BRANCH}" --no-edit -m "chore: merge ${PR_BRANCH} into develop_auto for deploy [auto]"; then
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            git merge --abort

            # Create conflict resolution branch
            CONFLICT_BRANCH="conflict/merge-pr-${GITHUB_RUN_ID}"
            git checkout -b "$CONFLICT_BRANCH" "origin/${PR_BRANCH}"
            git push origin "$CONFLICT_BRANCH"

            # Create PR
            if ! PR_URL=$(gh pr create --base develop_auto --head "$CONFLICT_BRANCH" --title "Resolve conflicts: Merge ${PR_BRANCH} into develop_auto" --body "Merge conflict detected while merging ${PR_BRANCH} into develop_auto for deployment. Please resolve conflicts here."); then
              echo "‚ö†Ô∏è Failed to create PR automatically (likely due to missing 'Allow GitHub Actions to create and approve pull requests' permission)."
              PR_URL="${{ github.server_url }}/${{ github.repository }}/compare/develop_auto...${CONFLICT_BRANCH}?expand=1"
            fi
            
            {
              echo "success=false"
              echo "conflict_stage=pr_branch_to_develop_auto"
              echo "conflict_files<<CONFLICT_EOF"
              echo "$CONFLICT_FILES"
              echo "CONFLICT_EOF"
              echo "conflict_pr_url=$PR_URL"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # --- Step 3: Push develop_auto ---
          git push origin develop_auto --force-with-lease
          echo "success=true" >> "$GITHUB_OUTPUT"

      - name: Comment on merge conflict
        if: steps.merge.outputs.success == 'false'
        uses: actions/github-script@v7
        env:
          CONFLICT_STAGE: ${{ steps.merge.outputs.conflict_stage }}
          CONFLICT_FILES: ${{ steps.merge.outputs.conflict_files }}
          CONFLICT_PR_URL: ${{ steps.merge.outputs.conflict_pr_url }}
          PR_BRANCH: ${{ steps.get_pr.outputs.branch }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const stage = process.env.CONFLICT_STAGE;
            const conflictFiles = process.env.CONFLICT_FILES || '(could not determine files)';
            const conflictPrUrl = process.env.CONFLICT_PR_URL;
            const prBranch = process.env.PR_BRANCH;
            const stageDescription = stage === 'main_to_develop_auto'
              ? 'merging `main` into `develop_auto`'
              : `merging \`${prBranch}\` into \`develop_auto\``;

            const body = [
              '‚ùå **Deploy to develop failed ‚Äî merge conflict**',
              '',
              `A conflict occurred while ${stageDescription}.`,
              '',
              '**Conflicting files:**',
              '```',
              conflictFiles.trim(),
              '```',
              '',
              `A conflict resolution pull request has been created: ${conflictPrUrl}`,
              '',
              'Please resolve the conflict in that pull request, merge it, and then re-trigger the deployment by commenting `develop deploy` here.',
              '',
              `**Workflow run:** ${process.env.RUN_URL}`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail job on merge conflict
        if: steps.merge.outputs.success == 'false'
        run: |
          echo "Merge conflict detected. See PR comment for details."
          exit 1

  deploy:
    name: Build and deploy develop_auto
    needs: prepare
    runs-on: ubuntu-latest
    environment: testing
    timeout-minutes: 60
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout develop_auto
        uses: actions/checkout@v4
        with:
          ref: develop_auto

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies and deploy
        run: |
          if [ -f "package.json" ]; then
            echo "package.json found, running npm install..."
            npm install
            
            if grep -q '"deploy:testing":' package.json; then
              echo "deploy:testing script found, executing..."
              npm run deploy:testing
            else
              echo "No deploy:testing script found in package.json."
              echo "Simulating deployment..."
            fi
          else
            echo "No package.json found."
            echo "Simulating deployment..."
          fi

  notify:
    name: Notify PR of deployment result
    needs: [prepare, deploy]
    # Always run this job as long as prepare succeeded (deploy may succeed or fail)
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Comment deployment success
        if: needs.deploy.result == 'success'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '‚úÖ **Successfully deployed to develop environment!**',
                '',
                'Branch `develop_auto` was synced from `main`, your PR branch was merged in, and the result was deployed to `testing`.',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

      - name: Comment deployment failure
        if: needs.deploy.result == 'failure'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '‚ùå **Deploy to develop environment failed**',
                '',
                'The build or deployment step encountered an error. Check the workflow logs for details.',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

      - name: Comment deployment cancelled
        if: needs.deploy.result == 'cancelled'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '‚ö†Ô∏è **Deploy to develop environment was cancelled**',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });
