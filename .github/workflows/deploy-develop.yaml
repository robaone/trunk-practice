name: Deploy PR to Develop

on:
  issue_comment:
    types: [created]

concurrency:
  group: deploy-develop
  cancel-in-progress: false

jobs:
  check-reset-needed:
    name: Check if develop_auto reset is needed
    if: >
      github.event.issue.pull_request != null &&
      (
        github.event.comment.body == 'develop deploy' ||
        startsWith(github.event.comment.body, 'develop deploy\n') ||
        endsWith(github.event.comment.body, '\ndevelop deploy') ||
        contains(github.event.comment.body, '\ndevelop deploy\n')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_branch: ${{ steps.get_pr.outputs.branch }}
      pr_number: ${{ steps.get_pr.outputs.number }}
      pr_author: ${{ steps.get_pr.outputs.author }}
      pr_title: ${{ steps.get_pr.outputs.title }}
      reset_needed: ${{ steps.check_reset.outputs.reset_needed }}
      removed_pr_data: ${{ steps.check_reset.outputs.removed_pr_data }}
      removed_pr_count: ${{ steps.check_reset.outputs.removed_pr_count }}
      removed_pr_summary: ${{ steps.check_reset.outputs.removed_pr_summary }}

    steps:
      - name: Verify commenter has write access
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor,
              });
              const hasWrite = ['admin', 'write', 'maintain'].includes(data.permission);
              if (!hasWrite) {
                core.setFailed(`@${context.actor} does not have write access and cannot trigger deployments (permission: ${data.permission}). Required: write, admin, or maintain.`);
              }
            } catch (e) {
              core.setFailed(`Could not verify permissions for @${context.actor}: ${e.message}`);
            }

      - name: Get PR info and block fork PRs
        id: get_pr
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            if (pr.data.head.repo.fork) {
              const body = [
                '‚ùå **Deploy to develop failed**',
                '',
                'Pull requests from forked repositories are not supported for security reasons.',
                'Please open a pull request from a branch on the main repository.',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
              
              core.setFailed('Fork PRs are not supported.');
              return;
            }

            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('number', context.issue.number);
            core.setOutput('author', pr.data.user.login);
            core.setOutput('title', pr.data.title);

      - name: Post workflow started comment
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'üöÄ **Deploy to develop triggered**',
                '',
                'Preparing `develop_auto` branch and queuing deployment to `connect-develop`...',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if develop_auto reset is needed
        id: check_reset
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --all

          RESET_NEEDED=false
          REMOVED_PR_DATA=""
          REMOVED_PR_SUMMARY=""
          
          if git ls-remote --exit-code --heads origin develop_auto > /dev/null 2>&1; then
            echo "develop_auto exists ‚Äî checking if main has new commits..."
            
            # Check if main has commits not in develop_auto
            NEW_COMMITS=$(git log origin/develop_auto..origin/main --oneline 2>/dev/null || echo "")
            
            if [ -n "$NEW_COMMITS" ]; then
              echo "‚ú® Main has new commits since last sync ‚Äî reset will be needed"
              echo "$NEW_COMMITS"
              RESET_NEEDED=true
              
              # BEFORE resetting, identify which PRs will be removed
              echo "üîç Identifying PRs that will be removed..."
              REMOVED_BRANCHES=$(git log origin/main..origin/develop_auto --merges \
                --grep="merge .* into develop_auto for deploy" --format="%s" 2>/dev/null | \
                sed -n 's/.*merge \(.*\) into develop_auto for deploy.*/\1/p' || echo "")
              
              # Query GitHub for each removed branch to get PR info
              for branch in $REMOVED_BRANCHES; do
                echo "  Checking branch: $branch"
                PR_JSON=$(gh pr list --head "$branch" --state open --json number,author,title --jq '.[0]' 2>/dev/null || echo "null")
                
                if [ "$PR_JSON" != "null" ] && [ -n "$PR_JSON" ]; then
                  PR_NUM=$(echo "$PR_JSON" | jq -r '.number // empty')
                  PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login // empty')
                  PR_TITLE=$(echo "$PR_JSON" | jq -r '.title // empty')
                  
                  if [ -n "$PR_NUM" ]; then
                    echo "    Found open PR #$PR_NUM by $PR_AUTHOR"
                    REMOVED_PR_DATA+="$PR_NUM|$branch|$PR_AUTHOR|$PR_TITLE"$'\n'
                    REMOVED_PR_SUMMARY+="‚Ä¢ PR #${PR_NUM} - ${branch} (@${PR_AUTHOR})"$'\n'
                  fi
                fi
              done
            else
              echo "üì¶ Main unchanged ‚Äî no reset needed"
              RESET_NEEDED=false
            fi
          else
            echo "develop_auto does not exist ‚Äî will be created from main (no approval needed)"
            RESET_NEEDED=false
          fi
          
          # Output results
          echo "reset_needed=$RESET_NEEDED" >> "$GITHUB_OUTPUT"
          
          if [ "$RESET_NEEDED" = "true" ] && [ -n "$REMOVED_PR_DATA" ]; then
            # Count non-empty lines
            REMOVED_COUNT=$(echo "$REMOVED_PR_DATA" | grep -c '|' || echo "0")
            echo "removed_pr_count=$REMOVED_COUNT" >> "$GITHUB_OUTPUT"
            echo "removed_pr_data<<EOF" >> "$GITHUB_OUTPUT"
            echo "$REMOVED_PR_DATA" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "removed_pr_summary<<EOF" >> "$GITHUB_OUTPUT"
            echo "$REMOVED_PR_SUMMARY" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "üìä Found $REMOVED_COUNT open PR(s) that will be removed"
          else
            echo "removed_pr_count=0" >> "$GITHUB_OUTPUT"
            echo "removed_pr_data=" >> "$GITHUB_OUTPUT"
            echo "removed_pr_summary=" >> "$GITHUB_OUTPUT"
          fi

  request-reset-approval:
    name: Request approval to reset develop_auto
    needs: check-reset-needed
    if: needs.check-reset-needed.outputs.reset_needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Slack Approval
        uses: TigerWest/slack-approval@v1.1.0
        env:
          SLACK_APP_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        timeout-minutes: 10
        with:
          approvers: ${{ vars.SLACK_APPROVERS }}
          custom-message: |
            üîÑ *Reset develop_auto branch?*
            
            Main has new commits. Resetting `develop_auto` will remove the following PRs:
            
            ${{ needs.check-reset-needed.outputs.removed_pr_summary }}
            
            *Triggered by:* PR #${{ needs.check-reset-needed.outputs.pr_number }} (@${{ needs.check-reset-needed.outputs.pr_author }})
            *Workflow:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  prepare:
    name: Prepare develop_auto branch
    needs: [check-reset-needed, request-reset-approval]
    if: |
      always() &&
      needs.check-reset-needed.result == 'success' &&
      (needs.request-reset-approval.result == 'success' || needs.request-reset-approval.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_branch: ${{ needs.check-reset-needed.outputs.pr_branch }}
      pr_number: ${{ needs.check-reset-needed.outputs.pr_number }}
      pr_author: ${{ needs.check-reset-needed.outputs.pr_author }}
      pr_title: ${{ needs.check-reset-needed.outputs.pr_title }}
      was_reset: ${{ steps.merge.outputs.was_reset }}
      removed_pr_count: ${{ needs.check-reset-needed.outputs.removed_pr_count }}
      removed_pr_data: ${{ needs.check-reset-needed.outputs.removed_pr_data }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare develop_auto and merge branches
        id: merge
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESET_NEEDED: ${{ needs.check-reset-needed.outputs.reset_needed }}
        run: |
          PR_BRANCH="${{ needs.check-reset-needed.outputs.pr_branch }}"
          git fetch --all

          # --- Step 1: Create or reset develop_auto ---
          WAS_RESET=false
          
          if git ls-remote --exit-code --heads origin develop_auto > /dev/null 2>&1; then
            if [ "$RESET_NEEDED" = "true" ]; then
              echo "‚ú® Resetting develop_auto to main (approved)"
              git checkout -B develop_auto origin/main
              WAS_RESET=true
            else
              echo "üì¶ Main unchanged ‚Äî merging into existing develop_auto"
              git checkout -B develop_auto origin/develop_auto
              
              if ! git merge origin/main --no-edit -m "chore: sync main into develop_auto [auto]"; then
                CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
                git merge --abort
                
                # Create conflict resolution branch
                CONFLICT_BRANCH="conflict/sync-main-${GITHUB_RUN_ID}"
                git checkout -b "$CONFLICT_BRANCH" origin/main
                git push origin "$CONFLICT_BRANCH"
                
                # Create PR
                if ! PR_URL=$(gh pr create --base develop_auto --head "$CONFLICT_BRANCH" --title "Resolve conflicts: Sync main into develop_auto" --body "Merge conflict detected while syncing main into develop_auto for deployment. Please resolve conflicts here."); then
                  echo "‚ö†Ô∏è Failed to create PR automatically (likely due to missing 'Allow GitHub Actions to create and approve pull requests' permission)."
                  PR_URL="${{ github.server_url }}/${{ github.repository }}/compare/develop_auto...${CONFLICT_BRANCH}?expand=1"
                fi
                
                {
                  echo "success=false"
                  echo "conflict_stage=main_to_develop_auto"
                  echo "conflict_files<<CONFLICT_EOF"
                  echo "$CONFLICT_FILES"
                  echo "CONFLICT_EOF"
                  echo "conflict_pr_url=$PR_URL"
                  echo "was_reset=false"
                } >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          else
            echo "develop_auto does not exist ‚Äî creating from main"
            git checkout -b develop_auto origin/main
            WAS_RESET=true
          fi

          # --- Step 2: Merge PR branch into develop_auto ---
          if ! git merge "origin/${PR_BRANCH}" --no-edit -m "chore: merge ${PR_BRANCH} into develop_auto for deploy [auto]"; then
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            git merge --abort

            # Create conflict resolution branch
            CONFLICT_BRANCH="conflict/merge-pr-${GITHUB_RUN_ID}"
            git checkout -b "$CONFLICT_BRANCH" "origin/${PR_BRANCH}"
            git push origin "$CONFLICT_BRANCH"

            # Create PR
            if ! PR_URL=$(gh pr create --base develop_auto --head "$CONFLICT_BRANCH" --title "Resolve conflicts: Merge ${PR_BRANCH} into develop_auto" --body "Merge conflict detected while merging ${PR_BRANCH} into develop_auto for deployment. Please resolve conflicts here."); then
              echo "‚ö†Ô∏è Failed to create PR automatically (likely due to missing 'Allow GitHub Actions to create and approve pull requests' permission)."
              PR_URL="${{ github.server_url }}/${{ github.repository }}/compare/develop_auto...${CONFLICT_BRANCH}?expand=1"
            fi
            
            {
              echo "success=false"
              echo "conflict_stage=pr_branch_to_develop_auto"
              echo "conflict_files<<CONFLICT_EOF"
              echo "$CONFLICT_FILES"
              echo "CONFLICT_EOF"
              echo "conflict_pr_url=$PR_URL"
              echo "was_reset=$WAS_RESET"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # --- Step 3: Push develop_auto ---
          git push origin develop_auto --force-with-lease
          
          # --- Step 4: Output results ---
          echo "success=true" >> "$GITHUB_OUTPUT"
          echo "was_reset=$WAS_RESET" >> "$GITHUB_OUTPUT"

      - name: Comment on merge conflict
        if: steps.merge.outputs.success == 'false'
        uses: actions/github-script@v7
        env:
          CONFLICT_STAGE: ${{ steps.merge.outputs.conflict_stage }}
          CONFLICT_FILES: ${{ steps.merge.outputs.conflict_files }}
          CONFLICT_PR_URL: ${{ steps.merge.outputs.conflict_pr_url }}
          PR_BRANCH: ${{ needs.check-reset-needed.outputs.pr_branch }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const stage = process.env.CONFLICT_STAGE;
            const conflictFiles = process.env.CONFLICT_FILES || '(could not determine files)';
            const conflictPrUrl = process.env.CONFLICT_PR_URL;
            const prBranch = process.env.PR_BRANCH;
            const stageDescription = stage === 'main_to_develop_auto'
              ? 'merging `main` into `develop_auto`'
              : `merging \`${prBranch}\` into \`develop_auto\``;

            const body = [
              '‚ùå **Deploy to develop failed ‚Äî merge conflict**',
              '',
              `A conflict occurred while ${stageDescription}.`,
              '',
              '**Conflicting files:**',
              '```',
              conflictFiles.trim(),
              '```',
              '',
              `A conflict resolution pull request has been created: ${conflictPrUrl}`,
              '',
              'Please resolve the conflict in that pull request, merge it, and then re-trigger the deployment by commenting `develop deploy` here.',
              '',
              `**Workflow run:** ${process.env.RUN_URL}`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prepare.outputs.pr_number }},
              body,
            });

      - name: Fail job on merge conflict
        if: steps.merge.outputs.success == 'false'
        run: |
          echo "Merge conflict detected. See PR comment for details."
          exit 1

  notify-approval-rejected:
    name: Notify that approval was rejected or timed out
    needs: [check-reset-needed, request-reset-approval]
    if: |
      always() &&
      needs.check-reset-needed.result == 'success' &&
      needs.request-reset-approval.result == 'failure'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Comment on PR about rejection
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-reset-needed.outputs.pr_number }},
              body: [
                'üö´ **Deploy to develop cancelled**',
                '',
                'The reset of `develop_auto` was rejected or timed out during the approval process.',
                '',
                'The `develop_auto` branch was not modified. If you still want to deploy:',
                '1. Wait for the conflicting PRs to be resolved or merged',
                '2. Re-trigger the deployment by commenting `develop deploy`',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

  deploy:
    name: Build and deploy develop_auto
    needs: [check-reset-needed, request-reset-approval, prepare]
    if: |
      always() &&
      needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    environment: testing
    timeout-minutes: 60
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout develop_auto
        uses: actions/checkout@v4
        with:
          ref: develop_auto

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies and deploy
        run: |
          if [ -f "package.json" ]; then
            echo "package.json found, running npm install..."
            npm install
            
            if grep -q '"deploy:testing":' package.json; then
              echo "deploy:testing script found, executing..."
              npm run deploy:testing
            else
              echo "No deploy:testing script found in package.json."
              echo "Simulating deployment..."
            fi
          else
            echo "No package.json found."
            echo "Simulating deployment..."
          fi

  notify:
    name: Notify PR of deployment result
    needs: [check-reset-needed, request-reset-approval, prepare, deploy]
    # Always run this job as long as prepare succeeded (deploy may succeed or fail)
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository for scripts
        uses: actions/checkout@v4

      - name: Comment deployment success
        if: needs.deploy.result == 'success'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          WAS_RESET: ${{ needs.prepare.outputs.was_reset }}
          REMOVED_PR_DATA: ${{ needs.prepare.outputs.removed_pr_data }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        with:
          script: |
            const wasReset = process.env.WAS_RESET === 'true';
            const removedPrData = process.env.REMOVED_PR_DATA || '';
            const repoUrl = process.env.REPO_URL;
            
            let body = [
              '‚úÖ **Successfully deployed to develop environment!**',
              '',
            ];
            
            if (wasReset && removedPrData.trim()) {
              body.push('‚ö†Ô∏è **Note:** `develop_auto` was reset to `main` (new commits detected)');
              body.push('');
              body.push('The following PRs were previously deployed but have been cleared:');
              
              // Parse removed PR data (format: PR_NUM|BRANCH|AUTHOR|TITLE)
              const lines = removedPrData.trim().split('\n').filter(line => line.includes('|'));
              for (const line of lines) {
                const [prNum, branch, author] = line.split('|');
                if (prNum && author) {
                  body.push(`- PR #${prNum} (@${author})`);
                }
              }
              
              body.push('');
              body.push('If they still need testing in develop, they should re-run `develop deploy`.');
              body.push('');
            } else if (wasReset) {
              body.push('Branch `develop_auto` was reset to `main` (new commits detected) and your PR was deployed.');
              body.push('');
            } else {
              body.push('Branch `develop_auto` was synced from `main`, your PR branch was merged in, and the result was deployed to `testing`.');
              body.push('');
            }
            
            body.push(`**Workflow run:** ${process.env.RUN_URL}`);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prepare.outputs.pr_number }},
              body: body.join('\n'),
            });

      - name: Send Slack notification for removed PRs
        if: needs.deploy.result == 'success' && needs.prepare.outputs.was_reset == 'true' && fromJSON(needs.prepare.outputs.removed_pr_count) > 0
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ vars.SLACK_CHANNEL_ID }}
        run: |
          chmod +x .github/scripts/notify-slack-removed-prs.sh
          .github/scripts/notify-slack-removed-prs.sh \
            "${{ needs.prepare.outputs.removed_pr_data }}" \
            "${{ needs.prepare.outputs.pr_number }}" \
            "${{ needs.prepare.outputs.pr_branch }}" \
            "${{ needs.prepare.outputs.pr_author }}" \
            "${{ needs.prepare.outputs.pr_title }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "${{ github.server_url }}/${{ github.repository }}"

      - name: Comment deployment failure
        if: needs.deploy.result == 'failure'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prepare.outputs.pr_number }},
              body: [
                '‚ùå **Deploy to develop environment failed**',
                '',
                'The build or deployment step encountered an error. Check the workflow logs for details.',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });

      - name: Comment deployment cancelled
        if: needs.deploy.result == 'cancelled'
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prepare.outputs.pr_number }},
              body: [
                '‚ö†Ô∏è **Deploy to develop environment was cancelled**',
                '',
                `**Workflow run:** ${process.env.RUN_URL}`,
              ].join('\n'),
            });
