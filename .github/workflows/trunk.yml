name: Trunk CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled, ready_for_review]
  release:
    types: [published]

env:
  NODE_VERSION: 22.x
  PROJECT_ROOT: project

jobs:
  initialize:
    name: Initialize
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false || (github.event.action == 'labeled' && contains(github.event.pull_request.labels.*.name, 'test')) }}
    permissions:
      actions: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cancel Previous Runs
        if: ${{ github.ref != 'refs/heads/main' }}
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - id: files
        uses: tj-actions/changed-files@v45

      - name: Get Latest Release
        id: get_latest_release
        run: |
          latest_release=$(./tooling/scripts/get_latest_release.sh)
          echo "Latest release is $latest_release"
          echo "result=$latest_release" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Project Matrix
        id: matrix
        run: |
          echo "## Modified Files"
          echo "${{ steps.files.outputs.all_changed_files }}" | sed -E 's/ /\n/g'

          # Generate matrix using the script
          matrixStringifiedObject="$(echo "${{ steps.files.outputs.all_changed_files }}" | sed -E 's/ /\n/g' | node ./tooling/scripts/generate_matrix.js)"
          echo "## Matrix Object"
          echo "$matrixStringifiedObject"
          echo "matrix=$matrixStringifiedObject" >> $GITHUB_OUTPUT

    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      latest-release: ${{ steps.get_latest_release.outputs.result }}

  unit-tests:
    name: Unit Tests
    needs: [initialize]
    if: ${{ fromJson(needs.initialize.outputs.matrix).include[0] != null && github.event_name != 'push' }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific unit test actions
      # Add a new step for each project that has custom unit tests:
      #
      # - uses: ./project/my-project/.github/action/unit-test
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/unit-test
        if: ${{ matrix.project == 'sample-calculator' }}

      - name: Run Root Unit Tests
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["test"]' package.json)" != "null" ]; then
              npm run test
            else
              echo "No test script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  feature-tests:
    name: Feature Tests
    needs: [initialize]
    if: ${{ fromJson(needs.initialize.outputs.matrix).include[0] != null && github.event_name != 'push' }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific feature test actions
      # Add a new step for each project that has custom feature tests:
      #
      # - uses: ./project/my-project/.github/action/feature-test
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/feature-test
        if: ${{ matrix.project == 'sample-calculator' }}

      - name: Run Root Feature Tests
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["test:e2e"]' package.json)" != "null" ]; then
              npm run test:e2e
            else
              echo "No test:e2e script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  update-pr-description:
    name: Update PR Description
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.base_ref == 'main' &&
      (github.event.pull_request.draft == false || github.event.action == 'labeled') &&
      (contains(github.event.pull_request.labels.*.name, 'auto-pr-description') || 
       (github.event.action == 'labeled' && contains(github.event.pull_request.labels.*.name, 'test')))
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR Description
        uses: VirdocsSoftware/github-actions/.github/actions/auto-pr-description@main
        with:
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}
          jira-ticket-url-prefix: 'https://vitalsource.atlassian.net/browse/'

  deploy-to-testing:
    name: Deploy to Testing
    needs: [initialize, unit-tests, feature-tests]
    environment: testing
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && fromJson(needs.initialize.outputs.matrix).include[0] != null }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific deploy-to-testing actions
      # Add a new step for each project that has custom deploy:testing:
      #
      # - uses: ./project/my-project/.github/actions/deploy-testing
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/deploy-testing
        if: ${{ matrix.project == 'sample-calculator' && hashFiles('project/sample-calculator/.github/actions/deploy-testing/action.yml') != '' }}

      - name: Run Root Deploy Testing
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["deploy:testing"]' package.json)" != "null" ]; then
              npm run deploy:testing
            else
              echo "No deploy:testing script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  deploy-to-production:
    name: Deploy to Production
    needs: [initialize]
    environment: production
    env:
      RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
    if: ${{ github.event_name == 'release' && startsWith(github.ref, 'refs/tags/') && fromJson(needs.initialize.outputs.matrix).include[0] != null }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific deploy-to-production actions
      # Add a new step for each project that has custom deploy:production:
      #
      # - uses: ./project/my-project/.github/actions/deploy-production
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/deploy-production
        if: ${{ matrix.project == 'sample-calculator' && hashFiles('project/sample-calculator/.github/actions/deploy-production/action.yml') != '' }}

      - name: Run Root Deploy Production
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["deploy:production"]' package.json)" != "null" ]; then
              npm run deploy:production
            else
              echo "No deploy:production script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

