name: Trunk CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled, ready_for_review]
  release:
    types: [published]

env:
  NODE_VERSION: 22.x
  PROJECT_ROOT: project

jobs:
  initialize:
    name: Initialize
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      (github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'deploy') || contains(github.event.pull_request.labels.*.name, 'test'))
    permissions:
      actions: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cancel Previous Runs
        if: ${{ github.ref != 'refs/heads/main' }}
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - id: files
        uses: tj-actions/changed-files@v45

      - name: Get Latest Release
        id: get_latest_release
        run: |
          latest_release=$(./tooling/scripts/get_latest_release.sh)
          echo "Latest release is $latest_release"
          echo "result=$latest_release" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Project Matrix
        id: matrix
        run: |
          echo "## Modified Files"
          echo "${{ steps.files.outputs.all_changed_files }}" | sed -E 's/ /\n/g'

          # Generate matrix using the script
          matrixStringifiedObject="$(echo "${{ steps.files.outputs.all_changed_files }}" | sed -E 's/ /\n/g' | node ./tooling/scripts/generate_matrix.js)"
          echo "## Matrix Object"
          echo "$matrixStringifiedObject"
          echo "matrix=$matrixStringifiedObject" >> "$GITHUB_OUTPUT"

    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      latest-release: ${{ steps.get_latest_release.outputs.result }}

  unit-tests:
    name: Unit Tests
    needs: [initialize]
    if: ${{ fromJson(needs.initialize.outputs.matrix).include[0] != null }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific unit test actions
      # Add a new step for each project that has custom unit tests:
      #
      # - uses: ./project/my-project/.github/action/unit-test
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/unit-test
        if: ${{ matrix.project == 'sample-calculator' }}

      - name: Run Root Unit Tests
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["test"]' package.json)" != "null" ]; then
              npm run test
            else
              echo "No test script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  feature-tests:
    name: Feature Tests
    needs: [initialize]
    if: ${{ fromJson(needs.initialize.outputs.matrix).include[0] != null }}
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific feature test actions
      # Add a new step for each project that has custom feature tests:
      #
      # - uses: ./project/my-project/.github/action/feature-test
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/feature-test
        if: ${{ matrix.project == 'sample-calculator' }}

      - name: Run Root Feature Tests
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["test:e2e"]' package.json)" != "null" ]; then
              npm run test:e2e
            else
              echo "No test:e2e script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  update-pr-description:
    name: Update PR Description
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto-pr-description')
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR Description
        uses: VirdocsSoftware/github-actions/.github/actions/auto-pr-description@v2.26.1
        with:
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}
          jira-ticket-url-prefix: 'https://vitalsource.atlassian.net/browse/'

  deploy-to-testing:
    name: Deploy to Testing
    needs: [initialize, unit-tests, feature-tests]
    environment: testing
    if: |
      fromJson(needs.initialize.outputs.matrix).include[0] != null &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
        (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy'))
      )
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific deploy actions
      # Add a new step for each project that has custom deploy:
      #
      # - uses: ./project/my-project/.github/actions/deploy
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/deploy
        if: ${{ matrix.project == 'sample-calculator' && hashFiles('project/sample-calculator/.github/actions/deploy/action.yml') != '' }}

      - name: Run Root Deploy Testing
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["deploy:testing"]' package.json)" != "null" ]; then
              npm run deploy:testing
            else
              echo "No deploy:testing script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  deploy-to-staging:
    name: Deploy to Staging
    needs: [initialize, unit-tests, feature-tests]
    environment: staging
    env:
      RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
    if: github.event_name == 'release' && github.event.release.prerelease == true && startsWith(github.ref, 'refs/tags/') && fromJson(needs.initialize.outputs.matrix).include[0] != null
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific deploy actions
      # Add a new step for each project that has custom deploy:
      #
      # - uses: ./project/my-project/.github/actions/deploy
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/deploy
        if: ${{ matrix.project == 'sample-calculator' && hashFiles('project/sample-calculator/.github/actions/deploy/action.yml') != '' }}

      - name: Run Root Deploy Staging
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["deploy:staging"]' package.json)" != "null" ]; then
              npm run deploy:staging
            else
              echo "No deploy:staging script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

  request-production-approval:
    name: Request Production Approval
    needs: [initialize, unit-tests, feature-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run for full releases (not pre-releases)
    if: github.event_name == 'release' && github.event.release.prerelease == false && fromJson(needs.initialize.outputs.matrix).include[0] != null
    steps:
      - name: Slack Approval
        uses: TigerWest/slack-approval@v1
        env:
          SLACK_APP_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        with:
          approvers: ${{ vars.SLACK_MEMBER_ID }}

      - name: Handle Timeout/Cancellation
        if: cancelled() || failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš« Deployment approval request timed out or was cancelled. Tag: ${{ github.event.release.tag_name }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  deploy-to-production:
    name: Deploy to Production
    needs: [initialize, unit-tests, feature-tests, request-production-approval]
    environment: production
    env:
      RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
    if: github.event_name == 'release' && github.event.release.prerelease == false && startsWith(github.ref, 'refs/tags/') && fromJson(needs.initialize.outputs.matrix).include[0] != null
    strategy:
      matrix: ${{ fromJson(needs.initialize.outputs.matrix) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================================
      # Project-specific deploy actions
      # Add a new step for each project that has custom deploy:
      #
      # - uses: ./project/my-project/.github/actions/deploy
      #   if: ${{ matrix.project == 'my-project' }}
      # ============================================================
      - uses: ./project/sample-calculator/.github/actions/deploy
        if: ${{ matrix.project == 'sample-calculator' && hashFiles('project/sample-calculator/.github/actions/deploy/action.yml') != '' }}

      - name: Run Root Deploy Production
        if: ${{ matrix.project == '.' }}
        run: |
          if [ -f "package.json" ]; then
            npm install
            if [ "$(jq -r '.scripts["deploy:production"]' package.json)" != "null" ]; then
              npm run deploy:production
            else
              echo "No deploy:production script found in package.json, skipping..."
            fi
          else
            echo "No package.json found at root, skipping..."
          fi

